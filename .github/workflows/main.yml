# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: 17.0.1
  ANCHOR_VERSION: 0.22.0
  SOLANA_VERSION_STABLE: 1.9.22
  RUST_TOOLCHAIN: stable
  PROGRAM_NAME: newworld
  ACCOUNT_ID: 813125037859
  REGION: us-east-1
  ROLE: uploadToS3Role
  BUCKET: programbuildsinfrastack-verifiablebuildbinariesb-1umx6gqtqe6gl

defaults:
  run:
    working-directory: ./programs/newworld

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  main-worklfow:
    name: Main workflow
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v3
      # - uses: ./.github/actions/install-linux-build-deps
      # - uses: ./.github/actions/install-solana
      #   with:
      #     solana_version: ${{ env.SOLANA_VERSION_STABLE }}
      # - uses: ./.github/actions/install-rust
      #   with:
      #     toolchain: ${{ env.RUST_TOOLCHAIN }}

      # - uses: ./.github/actions/anchor-publish/
      #   with:
      #     program: $PROGRAM_NAME

      # - name: Print program artifacts
      #   run: |
      #     ls ../../target/verifiable

      # # todo: parse toml for version and use that in S3 prefix
      # - name: Upload binary to S3
      #   uses: ./.github/actions/upload-to-s3/
      #   id: upload-binary
      #   with:
      #     path: ../../targets/deploy/newworld.so
      #     name: ${{ env.PROGRAM_NAME }}.so
      #     account-id: ${{ env.ACCOUNT_ID }}
      #     region: ${{ env.REGION }}
      #     role: ${{ env.ROLE }}
      #     bucket: ${{ env.BUCKET }}
      #     prefix: newworld/${{ github.event.head_commit.id }}

      - name: Set URL to binary
        run: echo '::set-output name=BINARY_PATH::output-path'
        shell: bash

      - name: Print binary output link
        run: echo "The output path for the binary is ${{ steps.upload-binary.outputs.BINARY_PATH }}"
        shell: bash

      # "binary_path": "${{ steps.upload-binary.outputs.url }}"
      # "id": "${{ github.event.head_commit.id }}",
      # "url": "${{ github.event.head_commit.url }}",
      # "timestamp": "${{ github.event.head_commit.timestamp }}",

      # dump commit context to index.json & upload that
      - name: Dump context to metadata
        run: |
          echo "$(cat <<-END
              {
                  "package": "newworld"
              }
          END
          )" > binary-context.json
        shell: bash

      - name: Upload binary metadata to S3
        uses: ./.github/actions/upload-to-s3/
        id: upload-binary-metadata
        with:
          path: ./binary-context.json
          name: index.json
          account-id: ${{ env.ACCOUNT_ID }}
          region: ${{ env.REGION }}
          role: ${{ env.ROLE }}
          bucket: ${{ env.BUCKET }}
          prefix: newworld
